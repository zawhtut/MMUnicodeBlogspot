@using SmartReader


<RadzenHeader Style="font-weight: 600; font-size: 20px; text-align: left">
    အောက်မှာ Text Box ထဲကို ZawGyi ပြနေတဲ့ Blogspot Link ကိုထည့်ပါ။
</RadzenHeader>
<RadzenTextBox Style="width: 90%; vertical-align: middle; text-align: left; min-height: 45px; font-size: 18px" Placeholder="Blogspot Link" @bind-Value="@CurrentValue" @oninput=@(async args => {CurrentValue=(string)args.Value; CheckLink(); await LoadArticle(); })>
</RadzenTextBox>

@*<input type="text" bind-Value="CurrentValue" @onchange="CheckLink" />
<RadzenHeader>@CurrentValue</RadzenHeader>*@

<div>
    @if (isValidLink)
    {
        <p>The link is valid.</p>
    }
    else if (!isValidLink)
    {
        <p>The link is not valid.</p>
    }
</div>
<div class="loading-progress circle" style="display:@(IsLoading ? "block" : "none")">
</div>
<div>
    @((MarkupString)_rawContent)
</div>

@code {
    private bool isValidLink = true;
    private bool _isLoading;
    private string _rawContent;
    public string CurrentValue { get; set; } = "http://mmbloggershelpdesk.blogspot.com/2012/01/facebook-like-button.html";

    public bool IsLoading
    {
        get => _isLoading;
        set {  _isLoading = value;
            StateHasChanged();  }
    }

    private async Task LoadArticle()
    {
        IsLoading = true;
        if (isValidLink)
        {
            using (var client = new HttpClient())
            {
                var response = await client.GetAsync(CurrentValue);
                if (response.IsSuccessStatusCode)
                {
                    Article article = await Task.Run(() =>
                    {
                        Reader reader = new Reader(CurrentValue);
                        return reader.GetArticle();
                    });
                    _rawContent = Rabbit.ZgToUni(article.Content);
                }
            }
        }
        IsLoading = false;
    }

    void CheckLink()
    {
        if (CurrentValue.Contains("blogspot.com"))
        {
            isValidLink = true;
        }
        else
        {
            isValidLink = false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadArticle();
    }
}
